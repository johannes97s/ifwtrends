if (lags >=1) index <- mutate(index, lag_1 = lag(s_adj))
if (lags >=2) index <- mutate(index, lag_2 = lag(s_adj,2))
if (lags >=3) index <- mutate(index, lag_3 = lag(s_adj,3))
if (lags == 4) index <- mutate(index, lag_3 = lag(s_adj,3))
index <- index %>%
ungroup() %>%
rename(lag_0 = s_adj) %>%
filter(across(everything(), ~!is.na(.))) %>%
pivot_longer(cols = -c(id, time), names_to = "lag", values_to = "value") %>%
pivot_wider(names_from = c(id, lag), values_from = value)
return(index)
}
g_index(keyword = NA, category = category,
time = str_c(start, " ", end),
lags = 2)
res
start = "2006-01-01"
readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
keyword = NA
category = 550
time = str_c("2006-01-01 ", Sys.Date())
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time)
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
dates <- seq.Date(from = as.Date(start), to = as.Date(end), by = "month")
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
dates <- seq.Date(from = as.Date(start), to = as.Date(end), by = "month")
fit <- readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
fit <- readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
g_dat2 %>%
left_join(fit, by = "time")
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(method = "arima")
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
dates
end
end = Sys.Date()
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
dates <- seq.Date(from = as.Date(start), to = as.Date(end), by = "month")
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(method = "arima")
dates <- seq.Date(from = as.Date(start), to = as.Date(end), by = "month")
fit <- readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(method = "arima")
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend)
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
dim(g_dat_adj)[2]
series <- ts_ts(g_dat_adj)
library(tsbox)
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
#' @import tsbox
#' @import gtrendsR
#' @import trendecon
#' @import zoo
#' @example \dontrun{
#' g_index(keyword = c("ikea","saturn"), time = "2018-01-01 2021-01-01")
#' }
#' @importFrom gtrendsR gtrends
#' @importFrom gtrendsR gtrends
#' @export
g_index <- function(
keyword = NA,
category = 0,
geo = "DE",
time = str_c("2006-01-01 ", Sys.Date()),
lags = 0){
start <- str_sub(time, 1,10)
end <- str_sub(time, 12,21)
dates <- seq.Date(from = as.Date(start), to = as.Date(end), by = "month")
fit <- readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima") %>%
rename(s_adj = value) %>%
unique()
if (!("id" %in% names(g_dat_adj))) g_dat_adj <- mutate(g_dat_adj, id = as.character(rep(category, each = length(dates))))
index <- g_dat_adj %>%
select(id, time, s_adj) %>%
group_by(id) %>%
#mutate(s_adj = c(0, diff(s_adj, 1))) %>%
group_by(id)
if (lags >=1) index <- mutate(index, lag_1 = lag(s_adj))
if (lags >=2) index <- mutate(index, lag_2 = lag(s_adj,2))
if (lags >=3) index <- mutate(index, lag_3 = lag(s_adj,3))
if (lags == 4) index <- mutate(index, lag_3 = lag(s_adj,3))
index <- index %>%
ungroup() %>%
rename(lag_0 = s_adj) %>%
filter(across(everything(), ~!is.na(.))) %>%
pivot_longer(cols = -c(id, time), names_to = "lag", values_to = "value") %>%
pivot_wider(names_from = c(id, lag), values_from = value)
return(index)
}
res_raw <- g_index(keyword = NA, category = category,
time = str_c(start, " ", end),
lags = 2)
series
g_dat_adj
series <- g_dat_adj
ts_ts(series)
dim(series)[2]
h <- function(ts){
m <- x13(ts)
return(m$final$series[,"sa"])
}
ts_tbl(h(series))
series
series <- ts_ts(series)
ts_tbl(h(series))
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#' @examples
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#'@import dplyr tsbox zoo
#'@import rJava
#' @importFrom RJDemetra x13
#' @importFrom gtrendsR gtrends
#'@export
seas_adj <-function(series, freq = "month", method = "arima"){
if(method == "arima"){
#Saisonbereinigung mit X-13 ARIMA
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
series <- ts_ts(series)
h <- function(ts){
m <- x13(ts)
return(m$final$series[,"sa"])
}
if (dim(series)[2] == 1) {series <- ts_tbl(h(series))}
if (dim(series)[2] > 1){
series <- as.list(series)
series <- lapply(series, h)
n <- names(series)
t1 <- series[[1]]
for (i in 2:length(series)) t1 <- ts_c(t1, series[[i]])
dimnames(t1)[[2]] <- n
series <- ts_tbl(t1)
}
}
if(method == "firstdiff"){     #Saisonbereinigung mit ersten Differenzen mit lag = 4
#da gerade Quartalsdaten. Fuer monatsdaten lag = 12
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
if (freq == "month") k = 12
if (freq == "quarter") k = 4
series <- series %>%
group_by(id) %>%
mutate(value = c(rep(0,k), diff(value, k))) %>% #Wenn Monatsdaten hier 12 statt 4
ungroup()
}
series
}
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
(dim(series)[2] == 1)
dim(series)[2]
series
series
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
series <- g_dat_adj
ts_ts(series)
dim(series)
series
dim(ts_ts(series))
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#' @examples
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#'@import dplyr tsbox zoo
#'@import rJava
#' @importFrom RJDemetra x13
#' @importFrom gtrendsR gtrends
#'@export
seas_adj <-function(series, freq = "month", method = "arima"){
if(method == "arima"){
#Saisonbereinigung mit X-13 ARIMA
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
h <- function(ts){
m <- x13(ts)
return(m$final$series[,"sa"])
}
if (dim(series)[2] == 1){
series <- ts_ts(series)
series <- ts_tbl(h(series))
}
if (dim(series)[2] > 1){
series <- ts_ts(series)
series <- as.list(series)
series <- lapply(series, h)
n <- names(series)
t1 <- series[[1]]
for (i in 2:length(series)) t1 <- ts_c(t1, series[[i]])
dimnames(t1)[[2]] <- n
series <- ts_tbl(t1)
}
}
if(method == "firstdiff"){     #Saisonbereinigung mit ersten Differenzen mit lag = 4
#da gerade Quartalsdaten. Fuer monatsdaten lag = 12
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
if (freq == "month") k = 12
if (freq == "quarter") k = 4
series <- series %>%
group_by(id) %>%
mutate(value = c(rep(0,k), diff(value, k))) %>% #Wenn Monatsdaten hier 12 statt 4
ungroup()
}
series
}
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
g_index(keyword = NA, category = category,
time = str_c(start, " ", end),
lags = 2)
series
dim(series)
series <- ts_ts(series)
as.list(series)
lapply(series, h)
g_dat_adj
category = c(550, 1010)
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 2)
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
series <- ts_ts(g_dat_adj)
serie
s
series
dim(series)
g_dat2 <- ts_gtrends(keyword = keyword,
category = 550,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
category = 550
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
ts_ts(g_dat_adj)
dim(.Last.value)
NULL == NULL
identical(NULL, NULL)
h(ts_ts(g_dat_adj))
category = c(550, 1010)
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
dim(ts_ts(g_dat_adj))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
dim(ts_ts(g_dat_adj))
category_test = c(560,121,277)
category = category_test
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 2)
res <- res_raw
res
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima") %>%
rename(s_adj = value) %>%
unique()
index <- g_dat_adj %>%
select(id, time, s_adj) %>%
group_by(id) %>%
#mutate(s_adj = c(0, diff(s_adj, 1))) %>%
group_by(id)
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima") %>%
rename(s_adj = value) %>%
unique()
g_dat_adj %>%
select(id, time, s_adj) %>%
group_by(id) %>%
#mutate(s_adj = c(0, diff(s_adj, 1))) %>%
group_by(id)
g_dat_adj
index <- g_dat_adj %>%
group_by(id)
mutate(index, lag_1 = lag(s_adj))
mutate(index, lag_2 = lag(s_adj,2))
g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 0)
tail(.Last.value)
r <-  roll(keyword = NA,
category = category_ret,
start_series = start_series,
start_period = start_period,
end = end,
fun = g_index,
lags = 0)
start_series = "2006-01-01"
start_period = "2018-01-01"
end = "2021-07-31"
