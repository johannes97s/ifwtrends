#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#' @examples
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#'@import dplyr tsbox zoo
#'@import rJava
#' @importFrom RJDemetra x13
#' @importFrom gtrendsR gtrends
#'@export
seas_adj <-function(series, freq = "month", method = "arima"){
if(method == "arima"){
#Saisonbereinigung mit X-13 ARIMA
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
h <- function(ts){
m <- x13(ts)
return(m$final$series[,"sa"])
}
if (dim(series)[2] == 1){
series <- ts_ts(series)
series <- ts_tbl(h(series))
}
if (dim(series)[2] > 1){
series <- ts_ts(series)
series <- as.list(series)
series <- lapply(series, h)
n <- names(series)
t1 <- series[[1]]
for (i in 2:length(series)) t1 <- ts_c(t1, series[[i]])
dimnames(t1)[[2]] <- n
series <- ts_tbl(t1)
}
}
if(method == "firstdiff"){     #Saisonbereinigung mit ersten Differenzen mit lag = 4
#da gerade Quartalsdaten. Fuer monatsdaten lag = 12
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
if (freq == "month") k = 12
if (freq == "quarter") k = 4
series <- series %>%
group_by(id) %>%
mutate(value = c(rep(0,k), diff(value, k))) %>% #Wenn Monatsdaten hier 12 statt 4
ungroup()
}
series
}
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
g_index(keyword = NA, category = category,
time = str_c(start, " ", end),
lags = 2)
series
dim(series)
series <- ts_ts(series)
as.list(series)
lapply(series, h)
g_dat_adj
category = c(550, 1010)
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 2)
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
series <- ts_ts(g_dat_adj)
serie
s
series
dim(series)
g_dat2 <- ts_gtrends(keyword = keyword,
category = 550,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
category = 550
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
ts_ts(g_dat_adj)
dim(.Last.value)
NULL == NULL
identical(NULL, NULL)
h(ts_ts(g_dat_adj))
category = c(550, 1010)
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
dim(ts_ts(g_dat_adj))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
dim(ts_ts(g_dat_adj))
category_test = c(560,121,277)
category = category_test
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 2)
res <- res_raw
res
ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj)
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima")
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima") %>%
rename(s_adj = value) %>%
unique()
index <- g_dat_adj %>%
select(id, time, s_adj) %>%
group_by(id) %>%
#mutate(s_adj = c(0, diff(s_adj, 1))) %>%
group_by(id)
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima") %>%
rename(s_adj = value) %>%
unique()
g_dat_adj %>%
select(id, time, s_adj) %>%
group_by(id) %>%
#mutate(s_adj = c(0, diff(s_adj, 1))) %>%
group_by(id)
g_dat_adj
index <- g_dat_adj %>%
group_by(id)
mutate(index, lag_1 = lag(s_adj))
mutate(index, lag_2 = lag(s_adj,2))
g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 0)
tail(.Last.value)
r <-  roll(keyword = NA,
category = category_ret,
start_series = start_series,
start_period = start_period,
end = end,
fun = g_index,
lags = 0)
start_series = "2006-01-01"
start_period = "2018-01-01"
end = "2021-07-31"
Sys.getenv("JAVA_HOME")
library(rJava)
library(rJava)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot\\")
detach("package:rJava", unload = TRUE)
library(rJava)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot")
detach("package:rJava", unload = TRUE)
library(rJava)
detach("package:rJava", unload = TRUE)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot\\jre")
library(rJava)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot\\bin")
detach("package:rJava", unload = TRUE)
detach("package:rJava", unload = TRUE)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot\\bin")
library(rJava)
Sys.setenv(JAVA_HOME = "C:/Program Files/OpenJDK/jdk-8.0.292.10-hotspot/bin")
detach("package:rJava", unload = TRUE)
library(rJava)
detach("package:rJava", unload = TRUE)
Sys.setenv(JAVA_HOME = "C:/Program Files/OpenJDK/jdk-8.0.292.10-hotspot")
library(rJava)
detach("package:rJava", unload = TRUE)
Sys.setenv(JAVA_HOME = "C:/Program Files/OpenJDK/jre-8.0.292.10-hotspot")
library(rJava)
remove.packages("rJava")
install.packages("rJava")
install.packages("rJava")
Sys.setenv(JAVA_HOME = "C:/Program Files/OpenJDK/jre-8.0.292.10-hotspot")
library(rJava)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jre-8.0.292.10-hotspot")
detach("package:rJava", unload = TRUE)
library(rJava)
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot")
detach("package:rJava", unload = TRUE)
library(rJava)
Sys.setenv(JAVA_HOME = "C:\Program Files\OpenJDK\jdk-8.0.292.10-hotspot")
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.292.10-hotspot")
detach("package:rJava", unload = TRUE)
library(rJava)
Sys.setenv(JAVA_HOME="")
detach("package:rJava", unload = TRUE)
library(rJava)
library(RJDemetra)
x13(AirPassengers)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jre1.8.0_121')
detach("package:rJava", unload = TRUE)
detach("package:RJDemetra", unload = TRUE)
library(rJava)
library(RJDemetra)
x13(AirPassengers)
Sys.setenv(JAVA_HOME='C:/Program Files/Java/jdk-17')
detach("package:rJava", unload = TRUE)
library(rJava)
detach("package:RJDemetra", unload = TRUE)
library(RJDemetra)
x13(AirPassengers)
remove.packages("RJDemetra")
install.packages("RJDemetra")
install.packages("RJDemetra")
install.packages("RJDemetra")
Sys.setenv(JAVA_HOME='C:/Program Files/Java/jdk-17')
library(rJava)
library(RJDemetra)
x13(AirPassengers)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jre-8.0.262.10-hotspot')
detach("package:rJava", unload = TRUE)
detach("package:RJDemetra", unload = TRUE)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jre-8.0.262.10-hotspot')
library(rJava)
library(RJDemetra)
x13(AirPassengers)
Sys.getenv()
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jdk-8.0.262.10-hotspot')
detach("package:rJava", unload = TRUE)
detach("package:RJDemetra", unload = TRUE)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jdk-8.0.262.10-hotspot')
library(rJava)
library(RJDemetra)
x13(AirPassengers)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jdk-8.0.262.10-hotspot/jre')
detach("package:rJava", unload = TRUE)
detach("package:RJDemetra", unload = TRUE)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jdk-8.0.262.10-hotspot/jre')
library(rJava)
library(RJDemetra)
x13(AirPassengers)
detach("package:rJava", unload = TRUE)
detach("package:RJDemetra", unload = TRUE)
Sys.setenv(JAVA_HOME='C:/Program Files/OpenJDK/jdk-8.0.262.10-hotspot/bin')
library(rJava)
library(RJDemetra)
x13(AirPassengers)
detach("package:rJava", unload = TRUE)
detach("package:RJDemetra", unload = TRUE)
options(java.parameters = "-Xmx1000m")
library(rJava)
library(RJDemetra)
x13(AirPassengers)
library(devtools)
check()
Sys.setenv(JAVA_HOME = "C:\\Program Files\\OpenJDK\\jdk-8.0.262.10-hotspot")
library(rJava)
library(RJDemetra)
x13(AirPassengers)
library(glmnet)
library(tidyverse)
library(ifwtrends)
library(lubridate)
library(zoo)
library(trendecon)
library(gtrendsR)
start = "2006-01-01"
install.packages("anytime")
library(trendecon)
library(gtrendsR)
start = "2006-01-01"
end = "2021-07-01"
retail <- readxl::read_xlsx("data/retail_GER.xlsx") %>%
transmute(time = floor_date(as.Date(Name), "month"), value = `BD RETAIL SALES EXCL CARS (CAL ADJ) X-12-ARIMA VOLA`)
dat <- retail %>%
mutate(value = log(as.numeric(value))) %>%
mutate(value = c(0, diff(value, 1))) %>%
filter(time >= as_date(start), time <= as_date(end))
View(dat)
keyword = c(NA)
category_aco= c(956, 276, 179)
category_ret = c(560, 121,
277, 123,
988, 68,
660, 658, 466, 465, 659, 948,
270, 271, 137, 158,
646, 249, 256,
898, 289, #Hier 3 Kategorien für Autokauf von RWI ausgelassen
382, 383,
355, 41, 439, 3, 1010, 432, 882, 614, 78, 408,
74,
179, 276,
7, 143, 146, 508, 38)
category_test = c(560,121,277)
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 0)
#' @import tsbox
#' @import gtrendsR
#' @import trendecon
#' @import zoo
#' @example \dontrun{
#' g_index(keyword = c("ikea","saturn"), time = "2018-01-01 2021-01-01")
#' }
#' @importFrom gtrendsR gtrends
#' @importFrom gtrendsR gtrends
#' @export
g_index <- function(
keyword = NA,
category = 0,
geo = "DE",
time = str_c("2006-01-01 ", Sys.Date()),
lags = 0){
start <- str_sub(time, 1,10)
end <- str_sub(time, 12,21)
dates <- seq.Date(from = as.Date(start), to = as.Date(end), by = "month")
fit <- readRDS("data/comtrend.rds") %>%
select(time = date, trend) %>%
filter(time >= as.Date(start))
g_dat2 <- ts_gtrends(keyword = keyword,
category = category,
geo = "DE",
time = time) %>%
mutate(value = log(value)) %>%
mutate(value = replace(value, value == -Inf, NA_real_)) %>%
mutate(value = na.approx(value, rule = 2))
if (!("id" %in% names(g_dat2))) g_dat2 <- mutate(g_dat2, id = as.character(as.vector(sapply(category, rep, length(dates)))))
g_dat_adj <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.Date(time), adj = value - trend) %>%
select(id, time, adj) %>%
seas_adj(freq = "quarter", method = "arima") %>%
rename(s_adj = value) %>%
unique()
if (!("id" %in% names(g_dat_adj))) g_dat_adj <- mutate(g_dat_adj, id = as.character(rep(category, each = length(dates))))
index <- g_dat_adj %>%
group_by(id)
#mutate(s_adj = c(0, diff(s_adj, 1))) %>%
if (lags >=1) index <- mutate(index, lag_1 = lag(s_adj))
if (lags >=2) index <- mutate(index, lag_2 = lag(s_adj,2))
if (lags >=3) index <- mutate(index, lag_3 = lag(s_adj,3))
if (lags == 4) index <- mutate(index, lag_3 = lag(s_adj,3))
index <- index %>%
ungroup() %>%
rename(lag_0 = s_adj) %>%
filter(across(everything(), ~!is.na(.))) %>%
pivot_longer(cols = -c(id, time), names_to = "lag", values_to = "value") %>%
pivot_wider(names_from = c(id, lag), values_from = value)
return(index)
}
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#' @examples
#'series <- trendecon::ts_gtrends(c("ikea", "saturn"), time = "2018-01-01 2021-01-01")
#'seas_adj(series, freq = "month", log.traf = TRUE, method = "firstdiff")
#'@import dplyr tsbox zoo
#'@import rJava
#' @importFrom RJDemetra x13
#' @importFrom gtrendsR gtrends
#'@export
seas_adj <-function(series, freq = "month", method = "arima"){
if(method == "arima"){
#Saisonbereinigung mit X-13 ARIMA
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
series <- ts_ts(series)
h <- function(ts){
m <- x13(ts)
return(m$final$series[,"sa"])
}
if (identical(dim(series), NULL)){
series <- ts_tbl(h(series))
}
if (dim(series)[2] > 1){
series <- as.list(series)
series <- lapply(series, h)
n <- names(series)
t1 <- series[[1]]
for (i in 2:length(series)) t1 <- ts_c(t1, series[[i]])
dimnames(t1)[[2]] <- n
series <- ts_tbl(t1)
}
}
if(method == "firstdiff"){     #Saisonbereinigung mit ersten Differenzen mit lag = 4
#da gerade Quartalsdaten. Fuer monatsdaten lag = 12
if (!("id" %in% names(series))) series <- mutate(series, id = "id")
if (freq == "month") k = 12
if (freq == "quarter") k = 4
series <- series %>%
group_by(id) %>%
mutate(value = c(rep(0,k), diff(value, k))) %>% #Wenn Monatsdaten hier 12 statt 4
ungroup()
}
series
}
#'@param fun Funktion, die auf die rollende Zeitreihe angewendet werden soll.
#'@param ... Zusaetzliche Parameter, die an die Funktion in fun weitergegeben werden
#'@return Monatliche Tabelle mit pca in jeder Spalte. Je Spalte wird ein neuer Monat hinzugenommen.
#'
#'@examples \dontrun{
#'roll(keyword = c("ikea", "saturn"), start_period = "2018-01-01", end = "2020-01-01")
#'}
#'@importFrom stringr str_c
#'@importFrom trendecon ts_gtrends
#'@export
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends,
...){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
dates <- seq.Date(as.Date(start_series), as.Date(end), by = "month")
n <- length(dates)
f <- function(d) fun(keyword = keyword,
category = category,
geo = geo,
time = stringr::str_c(start_series," ", d),
...)
tl <- lapply(period, f)
return(tl)
}
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 0)
library(tsbox)
res_raw <- g_index(keyword = NA, category = category_test,
time = str_c(start, " ", end),
lags = 0)
start_series = "2006-01-01"
start_period = "2018-01-01"
end = "2021-07-31"
r <-  roll(keyword = NA,
category = category_ret,
start_series = start_series,
start_period = start_period,
end = end,
fun = g_index,
lags = 0)
