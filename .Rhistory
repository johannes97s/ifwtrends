#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll(keyword = "ikea")
roll(keyword = "ikea")
lapply(1:10, print)
lapply(1:10, abs)
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
n <- length(seq.Date(as.Date(start_series), as.Date(end), by = "month"))
tb <- lapply(period, fun())
print(keyword)
f <- function(d) fun(keyword = !!keyword,
category = category,
geo = geo,
time = str_c(start_series," ", d))
tl <- lapply(period, f)
tl <- lapply(tl, function(x){
rest <- matrix(NA, n - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
as_tibble(tl, .name_repair = "universal")
# if (pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#         select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("PC", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# if (!pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll(keyword = "ikea")
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
n <- length(seq.Date(as.Date(start_series), as.Date(end), by = "month"))
print(keyword)
f <- function(d) fun(keyword = keyword,
category = category,
geo = geo,
time = str_c(start_series," ", d))
tl <- lapply(period, f)
tl <- lapply(tl, function(x){
rest <- matrix(NA, n - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
as_tibble(tl, .name_repair = "universal")
# if (pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#         select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("PC", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# if (!pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll(keyword = "ikea")
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
n <- length(seq.Date(as.Date(start_series), as.Date(end), by = "month"))
print(keyword)
f <- function(d) fun(keyword = keyword,
category = category,
geo = geo,
time = strinr::str_c(start_series," ", d))
tl <- lapply(period, f)
tl <- lapply(tl, function(x){
rest <- matrix(NA, n - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
as_tibble(tl, .name_repair = "universal")
# if (pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#         select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("PC", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# if (!pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
n <- length(seq.Date(as.Date(start_series), as.Date(end), by = "month"))
print(keyword)
f <- function(d) fun(keyword = keyword,
category = category,
geo = geo,
time = strinr::str_c(start_series," ", d))
tl <- lapply(period, f)
tl <- lapply(tl, function(x){
rest <- matrix(NA, n - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
as_tibble(tl, .name_repair = "universal")
# if (pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#         select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("PC", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# if (!pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll(keyword = "ikea")
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
n <- length(seq.Date(as.Date(start_series), as.Date(end), by = "month"))
print(keyword)
f <- function(d) fun(keyword = keyword,
category = category,
geo = geo,
time = stringr::str_c(start_series," ", d))
tl <- lapply(period, f)
tl <- lapply(tl, function(x){
rest <- matrix(NA, n - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
as_tibble(tl, .name_repair = "universal")
# if (pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#         select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("PC", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# if (!pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll(keyword = "ikea")
roll(keyword = "ikea", end = "2015-01-01")
library(tidyverse)
library(gtrendsR)
library(trendecon)
library(tsbox)
library(zoo)
library(caret)
library(glmnet)
library(lattice)
roll(keyword = "ikea", end = "2015-01-01")
print(.Last.value, n = 120)
f<-function(d){
ts_gtrends(keyword = "ikea",
time = str_c("2006-01-01 ", d))
}
tl <- lapply(tl, function(x){
rest <- matrix(NA, 106 - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
f<-function(d){
ts_gtrends(keyword = "ikea",
time = str_c("2006-01-01 ", d))
}
period <-  seq.Date(as.Date("2009-01-01"), as.Date("2010-01-01"), by = "month")
tl <- lapply(period, f)
tl
roll <- function(keyword = NA,
category = 0,
geo = "DE",
start_series = "2006-01-01",
start_period = "2014-01-01",
end = Sys.Date(),
fun = trendecon::ts_gtrends){
period <-  seq.Date(as.Date(start_period), as.Date(end), by = "month")
dates <- seq.Date(as.Date(start_series), as.Date(end), by = "month")
n <- length(dates)
print(keyword)
f <- function(d) fun(keyword = keyword,
category = category,
geo = geo,
time = stringr::str_c(start_series," ", d))
tl <- lapply(period, f)
tl <- lapply(tl, function(x){
select(x, -time)
rest <- matrix(NA, n - nrow(x), 1)
colnames(rest) <- "value"
rest <- as_tibble(rest)
bind_rows(x, as_tibble(rest))} )
as_tibble(tl, .name_repair = "universal")
# if (pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#         select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("PC", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# if (!pc){
#   for (i in period){
#     d <- as.Date(i, origin = "1970-01-01")
#     pca(keywords = keywords,
#         categories = categories,
#         start = start_series,
#         geo = geo,
#         end = d,
#         components = components) %>%
#       select(-date) -> temp
#     rest <- matrix(NA, n - nrow(temp), components)
#     colnames(rest) <- str_c("ser", 1:components)
#     rest <- as_tibble(rest)
#     temp <- bind_rows(temp, rest)
#     names(temp) <- str_c(names(temp), " to ", d)
#     pc <- bind_cols(pc, temp)
#   }
# }
# pc
}
roll(keyword = "ikea", end = "2015-01-01")
roll(keyword = "ikea", end = "2014-05-01")
ts_gtrends(c("ikea", "saturn", "media", "amazom"))
map(function(x) x+2, 1:10)
map(1:10, function(x) x+2)
lapply(1:10, function(x) x+2)
for (i in 1:10) i+2
return(for (i in 1:10) i+2)
identical(map, lapply)
g_index <- function(
keywords = NA,
categories = 0,
geo = "DE",
end = Sys.Date(),
dat,
fd = T){
dates <- seq.Date(from = as.Date( "2006-01-01"), to = as.Date(end), by = "month")
dat <- dat %>%
mutate(time = as.yearqtr(as.Date(time))) %>%
filter(time <= as.yearqtr(as.Date(end))) %>%
mutate(time = as.Date(time)) %>%
mutate(value = log(value)) %>%
select(time, dat = value)
fit <- as_tibble(openxlsx::read.xlsx("~/ifwtrends/data/trend_67_0921.xlsx", detectDates = T)) %>%
select(time = date, fit)
g_dat2 <- ts_gtrends(keyword = keywords,
category = categories,
geo = "DE",
time = str_c("2006-01-01 ", end)) %>%
mutate(value = log(value))
#g_dat <- ts_pick(ts_prcomp(g_dat), "PC1")
g_dat <- g_dat2 %>%
left_join(fit, by = "time") %>%
mutate(time = as.yearqtr(time)) %>%
group_by(time, id) %>%
mutate(value = mean(value), fit = mean(fit)) %>%
ungroup() %>%
unique() %>%
mutate(time = as.Date(time)) %>%
filter(time <= max(dat$time)) %>%
mutate(adj = value - fit)
g_dat_adj <- g_dat %>%
select(id, time, adj) %>%
seas_adj(freq = "quart", method = "arima") %>%
rename(s_adj = value)
g_dat <- left_join(g_dat, g_dat_adj, by = c("time", "id")) %>%
left_join(dat, by = "time") %>%
unique()
# g_dat %>%
#   select(id, time, s_adj, dat) %>%
#   pivot_longer(cols = -c("id", "time"), names_to = "key", values_to = "values") %>%
#   #filter(id == "Koffer") %>%
#   ggplot(aes(x = time, y = values, color = id)) +
#   facet_grid(key ~., scales = "free_y" ) +
#   geom_line()
index <- g_dat %>%
select(id, time, s_adj, dat) #%>%
#group_by(id) %>%
#mutate(s_adj = c(0, diff(s_adj)), dat = c(0, diff(dat)))
# index %>%
#     pivot_longer(cols = -c("id", "time"), names_to = "key", values_to = "values") %>%
#     #filter(id == "Koffer") %>%
#     ggplot(aes(x = time, y = values, color = id)) +
#     facet_grid(key ~., scales = "free_y" ) +
#     geom_line()
index <- index %>%
pivot_wider(names_from = id, values_from = s_adj)
y <- index[[2]]
x <- as.matrix(index[-c(1:2)])
cv <- cv.glmnet(x, y, alpha = 0)
model <- glmnet(x, y, alpha = 0, lambda = cv$lambda.min1)
index<- bind_cols(index, as_tibble(predict(model, x, cv$lambda.min)))
# index %>%
#   select(time, dat, s1) %>%
#   pivot_longer(cols = -time, names_to = "key", values_to = "values") %>%
#   #filter(id == "Koffer") %>%
#   ggplot(aes(x = time, y = values, color =key)) +
#   #facet_grid(key ~., scales = "free_y" ) +
#   geom_line()
k = 4
fd_tb <- index %>%
select(time, dat, s1) %>%
mutate(dat = c(rep(0,k), diff(dat,k)), s1 = c(rep(0,k), diff(s1,k)))
# fd_tb %>%
#   pivot_longer(cols = -time, names_to = "key", values_to = "values") %>%
#   #filter(id == "Koffer") %>%
#   ggplot(aes(x = time, y = values, color =key)) +
#   #facet_grid(key ~., scales = "free_y" ) +
#   geom_line()
if (fd) return(fd_tb)
else return(index)
}
dat <- readxl::read_xlsx("~/Google Trends/Service_Import.xlsx")
names(dat) <- c("time","value")
keywords = c("Koffer",
"Reisepass",
"dienstreise",
"stau",
"flug",
"Hotel")
res <- g_index(keywords = keywords, dat = dat)
f<-function(k){
ts_gtrends(keyword = "ikea",
time = str_c("2006-01-01 ", "2009-01-01"))
}
keywords = c("ikea", "saturn")
tl <- lapply(keywords, f)
